---
title: "Predicting Blood Donations"
author: "Lila Jomok"
date: "November 14, 2017"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: spacelab
    variant: markdown_github
---

# About
In addition to refreshing data analysis skills, our goal is to build a statistical model to predict if a blood donor will donate within a given time window, which is March 2007. 

# Data
The provided datasets, `trainingData.csv` and `testData.csv` contain the following variables:

- `X1`: ID of donor.
- `Months since Last Donation`: Number of months since the donor's most recent blood donation.
- `Number of Donations`: Total number of donations the donor has made.
- `Total Volume Donated`: Total amount of blood the donor has donated in cubic centimeters.
- `Months since First Donation`: Number of months since the donor's first blood donation.
- `Made Donation in March 2007`: The explanatory variable or result - `1` if they donated blood, `0` if they did not donate blood in March 2007.

We can view the first couple of observations of the datasets below:
```{r, message=FALSE, warning=FALSE}
# Set working directory and load packages
getwd()
library(tidyverse)
library(gridExtra)

# Import datasets; adjust if datasets are in a different directory
testData = read.csv("data/testData.csv", header = TRUE)
trainingData = read.csv("data/trainingData.csv", header = TRUE)

# Display first rows of datasets
head(trainingData)
head(testData)
```
Since `testData` is our testing data set, it does not have `Made Donation in March 2007` variable.

## Renaming Variables
To make the data analysis more simple, we will rename the variables using `colnames()`:
```{r, message=FALSE, warning=FALSE}
# Rename variables in testData and trainingData
colnames(testData) <- c("ID", "mosLastDo", "numDonations", "totVol", "mosFirstDo")
colnames(trainingData) <- c("ID", "mosLastDo", "numDonations", "totVol", "mosFirstDo", "madeDonation")

# Display first rows of datasets (to confirm name changes)
head(trainingData)
head(testData)
```

# Exploratory Data Analysis
Since we are interested in whether the donor will donate again in March 2007, there are two possible outcomes: either they donate or do not donate. A logistic regression model is suitable for this, but we will first do some exploratory data analysis. Having a visual idea of the data will help us see if we need to do some transformations and see possible problems with our dataset.

First, we need to make the binary factor `madeDonation` is read as a categorical variable. Otherwise, the `0` and `1` values will be read as continuous variables instead of two groups.  
```{r, message=FALSE, warning=FALSE}
# Turn madeDonation into factors instead of continuous
trainingData$madeDonation <- factor(trainingData$madeDonation)
contrasts(trainingData$madeDonation)
```

We plot Boxplots of the two groups to see if there are any patterns:
```{r}
# Boxplots
plot01 <- ggplot(data = trainingData) + geom_boxplot(aes(x = madeDonation, y = numDonations)) + labs(title = "Number of Donations", subtitle = "Made Donations vs. No Donations")
plot02 <- ggplot(data = trainingData) + geom_boxplot(aes(x = madeDonation, y = totVol)) + labs(title = "Total Volume Donated", subtitle = "Made Donations vs. No Donations")
plot03 <- ggplot(data = trainingData) + geom_boxplot(aes(x = madeDonation, y = mosLastDo)) + labs(title = "Months since Last Donation", subtitle = "Made Donations vs. No Donations")
plot04 <- ggplot(data = trainingData) + geom_boxplot(aes(x = madeDonation, y = mosFirstDo)) + labs(title = "Months since First Donation", subtitle = "Made Donations vs. No Donations")
grid.arrange(plot01, plot02, plot03, plot04, ncol = 2)
```

`numDonations` and `totVol` look similar, which makes sense - the total amount of blood donated *should* increase as the number of donations increase. If we create a new variable that takes the average, `avgVolPerDo`, the average will be the same for each donor - 250 cubic centimeters. However, the number of donations varies among the donors, so we will create a variable `donFreq` which is the length of time between a donor's first and last donation divided by the total number of donations.

We can also create a new binary variable `firstTime` to indicate which donors are donating for the first time.
```{r}
TD2 <- mutate(trainingData, donFreq = (mosFirstDo - mosLastDo) / numDonations)
TD2 <- mutate(TD2, firstTime = ifelse(mosFirstDo == mosLastDo, "0", "1"))
TD2$firstTime <- factor(TD2$firstTime) # turn into factors
head(TD2)
```

# Logistic Regression Analysis

We will consider a simple logistic linear model for our data.
```{r}
model01 <- glm(madeDonation ~ mosLastDo + numDonations + mosFirstDo + donFreq + firstTime, family = binomial(link = 'logit'), data = TD2)
summary(model01)
```

At the significance level of 0.05, `mosLastDo` and `firstTime` are statistically significant.

- For every unit change in `mosLastDo`, the log odds of donating in March 2007 reduces by `0.09708`.
- If the donor is a NOT first-time donor (`firstTime1`), the log odds of donating in March 2007 changes by `1.29274`.

